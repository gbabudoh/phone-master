// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../lib/prisma-client"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  admin
  buyer
  personal_seller
  retail_seller
  wholesale_seller
}

enum UserStatus {
  active
  pending_verification
  suspended
}

enum SellerPlan {
  wholesale_sub
  retail_sub
  free
}

model User {
  id                    String        @id @default(cuid())
  email                 String        @unique
  password              String
  name                  String?
  role                  UserRole      @default(buyer)
  status                UserStatus    @default(pending_verification)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  profile               UserProfile?
  sellerDetails         SellerDetails?
  products              Product[]     @relation("SellerProducts")
  boughtTransactions    Transaction[] @relation("BuyerTransactions")
  soldTransactions      Transaction[] @relation("SellerTransactions")
  chatSessions          ChatSession[]
  sentMessages          Message[]     @relation("SentMessages")
  receivedMessages      Message[]     @relation("ReceivedMessages")
  conversationsAsUser1  Conversation[] @relation("ConversationUser1")
  conversationsAsUser2  Conversation[] @relation("ConversationUser2")
}

model UserProfile {
  id        String  @id @default(cuid())
  userId    String  @unique
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName String?
  lastName  String?
  phone     String?
  avatar    String?
  address   Json?   // { street, city, postcode, country }
}

model SellerDetails {
  id               String     @id @default(cuid())
  userId           String     @unique
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan             SellerPlan @default(free)
  stripeAccountId  String?
  companyName      String?
  vatNumber        String?
  businessAddress  Json?      // { street, city, postcode, country }
  activeListings   Int        @default(0)
}

enum ProductCategory {
  handset
  accessory
  service_voucher
}

enum ProductStatus {
  active
  sold
  draft
  under_review
}

model Product {
  id               String          @id @default(cuid())
  sellerId         String
  seller           User            @relation("SellerProducts", fields: [sellerId], references: [id])
  category         ProductCategory
  title            String
  description      String
  price            Float
  stock            Int             @default(1)
  images           String[]
  status           ProductStatus   @default(active)
  handsetDetails   Json?           // { model, brand, IMEI, condition, grade, networkStatus, storage, color, networkLock }
  accessoryDetails Json?           // { type, compatibility, oem, brand }
  serviceDetails   Json?           // { type, provider, validity, network }
  wholesaleDetails Json?           // { minOrderQuantity, termsAndConditions, discountTiers, shippingOptions }
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  transactionItems TransactionItem[]

  @@index([sellerId, status])
  @@index([category, status])
}

enum EscrowStatus {
  held
  released
  disputed
}

enum PayoutStatus {
  pending
  paid
  failed
}

model Transaction {
  id                    String            @id @default(cuid())
  buyerId               String
  buyer                 User              @relation("BuyerTransactions", fields: [buyerId], references: [id])
  sellerId              String
  seller                User              @relation("SellerTransactions", fields: [sellerId], references: [id])
  items                 TransactionItem[]
  totalAmount           Float
  commissionFee         Float             @default(0)
  netPayout             Float
  stripeChargeId        String
  stripePaymentIntentId String?
  escrowStatus          EscrowStatus      @default(held)
  payoutStatus          PayoutStatus      @default(pending)
  purchaseDate          DateTime          @default(now())
  releaseDate           DateTime?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([buyerId, createdAt(sort: Desc)])
  @@index([sellerId, createdAt(sort: Desc)])
  @@index([escrowStatus])
  @@index([payoutStatus])
}

model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  productTitle  String
  quantity      Int
  unitPrice     Float
  totalPrice    Float
}

enum ChatSender {
  user
  chatbot
}

enum ChatTopic {
  troubleshooting
  compatibility
  value_estimate
  general
  repair
}

model ChatSession {
  id        String        @id @default(cuid())
  userId    String?
  user      User?         @relation(fields: [userId], references: [id])
  sessionId String        @unique
  topic     ChatTopic?
  messages  ChatMessage[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([userId, createdAt(sort: Desc)])
}

model ChatMessage {
  id            String      @id @default(cuid())
  chatSessionId String
  chatSession   ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)
  sender        ChatSender
  content       String      @db.Text
  timestamp     DateTime    @default(now())
}

model Banner {
  id          String   @id @default(cuid())
  title       String
  description String?
  imageUrl    String
  videoUrl    String?
  linkUrl     String?
  linkText    String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  startDate   DateTime?
  endDate     DateTime?
  clicks      Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, order])
  @@index([startDate, endDate])
}


// Internal Messaging System
model Conversation {
  id          String    @id @default(cuid())
  user1Id     String
  user1       User      @relation("ConversationUser1", fields: [user1Id], references: [id])
  user2Id     String
  user2       User      @relation("ConversationUser2", fields: [user2Id], references: [id])
  productId   String?   // Optional: link to a product being discussed
  messages    Message[]
  lastMessage String?
  lastMessageAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([user1Id, user2Id])
  @@index([user1Id, lastMessageAt(sort: Desc)])
  @@index([user2Id, lastMessageAt(sort: Desc)])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation("SentMessages", fields: [senderId], references: [id])
  receiverId     String
  receiver       User         @relation("ReceivedMessages", fields: [receiverId], references: [id])
  content        String       @db.Text
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([receiverId, isRead])
}

model ContentPage {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  content   String   @db.Text
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SystemSettings {
  id             String   @id @default("global")
  platformName   String   @default("Phone Master")
  supportEmail   String   @default("support@phonemaster.com")
  
  // Social Media
  facebookUrl    String?
  instagramUrl   String?
  xUrl           String?
  linkedInUrl    String?

  // Financial Rules
  commissionRate Float    @default(10.0) // Percentage
  minWithdrawal  Int      @default(1000) // in pence
  maxWithdrawal  Int      @default(100000) // in pence

  updatedAt      DateTime @updatedAt
}
